<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سجل المربين</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* التنسيقات الأساسية */
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      color: #333;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-top: 30px;
      position: relative;
    }
    .hidden {
      display: none;
    }
    /* زر القائمة الرئيسي */
    .menu-btn {
      background-color: #009688;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      border-radius: 5px;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .menu-btn:hover {
      background-color: #00796b;
      transform: scale(1.02);
    }
    /* قائمة التنقل */
    .menu {
      position: absolute;
      top: 10px;
      right: 10px;
      left: auto;
      display: none;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 200px;
      z-index: 1000;
    }
    .menu.show {
      display: block;
      animation: slideIn 0.5s forwards;
    }
    .menu .menu-btn {
      display: block;
      margin-bottom: 10px;
    }
    .record {
      background-color: #f9f9f9;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      border: 1px solid #ddd;
      transition: background-color 0.3s ease;
      opacity: 0;
      animation: fadeInUp 0.5s forwards;
    }
    .record:hover {
      background-color: #f1f1f1;
    }
    .record .toggle-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 0; /* في البداية تكون على اليسار */
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: silver;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .record .toggle-btn.right {
      left: auto;
      right: 0;
      background-color: green;
    }
    .edit-btn,
    .delete-btn,
    .hide-btn,
    .details-btn {
      background-color: #FFC107;
      color: white;
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      border-radius: 5px;
    }
    .delete-btn {
      background-color: #E91E63;
    }
    .hide-btn {
      background-color: #FF5722;
    }
    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="datetime-local"],
    input[type="date"],
    select {
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    /* تنسيق حقل التاريخ الاختياري */
    .custom-date {
      border: 2px solid #009688;
      background-color: #e0f2f1;
      color: #333;
    }
    /* تأثير إسقاط كلمة الترحيب */
    #welcome {
      animation: dropDown 1.5s ease-out;
    }
    @keyframes dropDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* تنسيق الإشعارات لتكون الأيقونة في أقصى اليمين */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 20px;
      border: 2px solid;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 2000;
      animation: shake 0.5s ease-in-out;
      min-width: 300px;
    }
    .notification.success {
      background-color: rgba(0, 128, 0, 0.3);
      border-color: #008000;
    }
    .notification.error {
      background-color: rgba(255, 0, 0, 0.3);
      border-color: #FF0000;
    }
    .notification .circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      flex-shrink: 0;
    }
    .notification.success .circle {
      background-color: #008000;
    }
    .notification.error .circle {
      background-color: #FF0000;
    }
    .notification .progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background-color: currentColor;
      width: 100%;
      animation: progressShrink 3s linear forwards;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }
    @keyframes progressShrink {
      from { width: 100%; }
      to { width: 0; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @keyframes shake {
      0% { transform: translateX(-50%) rotate(0deg); }
      25% { transform: translateX(-50%) rotate(3deg); }
      50% { transform: translateX(-50%) rotate(0deg); }
      75% { transform: translateX(-50%) rotate(-3deg); }
      100% { transform: translateX(-50%) rotate(0deg); }
    }
    /* نافذة التنبيه عند عدم حفظ النموذج */
    .unsaved-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #FFF9C4;
      border: 2px solid #FBC02D;
      border-radius: 8px;
      padding: 20px;
      z-index: 3000;
      text-align: center;
    }
    .unsaved-modal .warning {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .unsaved-modal .warning .text {
      flex: 1;
      text-align: center;
      font-weight: bold;
    }
    .unsaved-modal .warning .icon {
      font-size: 24px;
      color: #FBC02D;
    }
    .unsaved-modal button {
      background-color: green;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- زر القائمة -->
  <button class="menu-btn" onclick="handleNavigation('menu')">☰ القائمة</button>

  <!-- القائمة الجانبية -->
  <div id="menu" class="menu">
    <button class="menu-btn" onclick="handleNavigation('main')">القائمة الرئيسية</button>
    <button class="menu-btn" onclick="handleNavigation('breeders')">سجل المربين</button>
    <button class="menu-btn" onclick="handleNavigation('resetPassword')">إعادة تعيين كلمة المرور</button>
    <!-- زر لوحة التحكم الإدارية يظهر فقط للحساب ownership -->
    <button id="adminPanelBtn" class="menu-btn hidden" onclick="handleNavigation('adminPanel')">لوحة التحكم الإدارية</button>
    <button class="menu-btn" onclick="logout()">تسجيل خروج</button>
  </div>

  <!-- نافذة التنبيه عند عدم حفظ النموذج -->
  <div id="unsavedModal" class="unsaved-modal hidden">
    <div class="warning">
      <span class="text">يرجى ارسال النموذج</span>
      <span class="icon">⚠️</span>
    </div>
    <button onclick="proceedToSection()">عدم الحفظ</button>
  </div>

  <!-- صفحة تسجيل الدخول -->
  <div id="login" class="container hidden">
    <h2>تسجيل الدخول</h2>
    <input type="text" id="loginUsername" placeholder="اسم المستخدم">
    <input type="password" id="loginPassword" placeholder="كلمة المرور">
    <button class="menu-btn" onclick="loginUser()">تسجيل الدخول</button>
    <p style="margin-top:15px;">
      <span style="color:#fff; background-color:#333; padding:5px 10px; border-radius:5px;">
        ليس لديك حساب؟ <a onclick="showSection('register')">اضغط هنا للإنشاء</a>
      </span>
    </p>
    <p style="margin-top:15px;">
      <a onclick="showSection('resetPassword')">نسيت كلمة المرور؟</a>
    </p>
  </div>

  <!-- صفحة إنشاء الحساب -->
  <div id="register" class="container hidden">
    <h2>إنشاء حساب</h2>
    <input type="text" id="registerUsername" placeholder="اسم المستخدم">
    <input type="email" id="registerEmail" placeholder="البريد الإلكتروني">
    <input type="password" id="registerPassword" placeholder="كلمة المرور">
    <input type="password" id="registerConfirmPassword" placeholder="تأكيد كلمة المرور">
    <button class="menu-btn" onclick="registerUser()">إنشاء حساب</button>
    <p style="margin-top:15px;">
      <span style="color:#fff; background-color:#333; padding:5px 10px; border-radius:5px;">
        هل لديك حساب؟ <a onclick="showSection('login')">اضغط هنا لتسجيل الدخول</a>
      </span>
    </p>
  </div>

  <!-- صفحة إعادة تعيين كلمة المرور -->
  <div id="resetPassword" class="container hidden">
    <h2>إعادة تعيين كلمة المرور</h2>
    <input type="text" id="resetUsername" placeholder="اسم المستخدم">
    <input type="email" id="resetEmail" placeholder="البريد الإلكتروني">
    <input type="password" id="resetNewPassword" placeholder="كلمة المرور الجديدة">
    <input type="password" id="resetConfirmPassword" placeholder="تأكيد كلمة المرور الجديدة">
    <button class="menu-btn" onclick="resetPassword()">إعادة تعيين كلمة المرور</button>
    <p style="margin-top:15px;">
      <span style="color:#fff; background-color:#333; padding:5px 10px; border-radius:5px;">
        لديك حساب؟ <a onclick="showSection('login')">اضغط هنا لتسجيل الدخول</a>
      </span>
    </p>
  </div>

  <!-- الصفحة الرئيسية بعد تسجيل الدخول -->
  <div id="main" class="container hidden">
    <h2 id="welcome">أهلا بك</h2>
    <input type="text" id="breederName" placeholder="اسم المربي">
    <input type="text" id="breederPhone" placeholder="رقم جوال المربي">
    <!-- حقل الموقع المضاف -->
    <input type="text" id="breederLocation" placeholder="الموقع">
    <select id="vaccineType">
      <option value="معوي">معوي</option>
      <option value="دموي">دموي</option>
      <option value="مزدوج">مزدوج</option>
      <option value="طاعون">طاعون</option>
      <option value="جدري">جدري</option>
      <option value="قلاعية">قلاعية</option>
    </select>
    <br><br>
    <label>تاريخ التطعيم:</label>
    <input type="datetime-local" id="vaccinationDate">
    <br><br>
    <label for="nextAppointment">الموعد الجاي بعد:</label>
    <select id="nextAppointment" onchange="handleNextAppointmentChange()">
      <option value="21">ثلاث أسابيع</option>
      <option value="14">اسبوعين</option>
      <option value="30">شهر</option>
      <option value="optional">اختياري</option>
    </select>
    <!-- حقل إضافي للموعد الاختياري يظهر عند الاختيار -->
    <div id="optionalDateDiv" class="hidden">
      <label>اختر التاريخ:</label>
      <input type="date" id="optionalNextAppointment" class="custom-date">
    </div>
    <br>
    <!-- قسم المواعيد السابقة -->
    <div id="previousAppointmentsSection">
      <h3>المواعيد السابقة (اختياري)</h3>
      <div id="previousAppointmentsContainer"></div>
      <button type="button" class="menu-btn" onclick="addPreviousAppointmentField()">أضف موعد سابق</button>
    </div>
    <br>
    <button class="menu-btn" onclick="addBreeder()">اضغط للإرسال</button>
  </div>

  <!-- صفحة سجل المربين -->
  <div id="breeders" class="container hidden">
    <h2>سجل المربين</h2>
    <input type="text" id="search" oninput="searchBreeders()" placeholder="بحث في السجل">
    <br><br>
    <div id="records-list"></div>
  </div>

  <!-- صفحة تفاصيل المربي -->
  <div id="breederDetail" class="container hidden">
    <h2>تفاصيل المربي</h2>
    <p id="detailName"></p>
    <p id="detailPhone"></p>
    <p id="detailLocation"></p>
    <p id="detailVaccine"></p>
    <p id="detailNextAppointment"></p>
    <h3>المواعيد السابقة:</h3>
    <div id="detailPreviousAppointments"></div>
    <br>
    <button class="menu-btn" onclick="showSection('breeders')">عودة إلى سجل المربين</button>
  </div>

  <!-- صفحة لوحة التحكم الإدارية -->
  <div id="adminPanel" class="container hidden">
    <h2>لوحة التحكم الإدارية</h2>
    <div id="accounts-list"></div>
  </div>

  <script>
    let breeders = [];
    let previousAppointments = [];
    let pendingSection = ""; // لتخزين القسم المطلوب التنقل إليه عند وجود بيانات غير محفوظة

    if (!localStorage.getItem("account_admin")) {
      let adminAccount = {
        username: "admin",
        email: "admin@example.com",
        password: "09090808",
        createdAt: new Date().toISOString()
      };
      localStorage.setItem("account_admin", JSON.stringify(adminAccount));
    }

    function handleNavigation(target) {
      // إذا كان المستخدم يحاول التنقل من صفحة main والحقول غير فارغة، نعرض نافذة التنبيه
      if (!document.getElementById("main").classList.contains("hidden")) {
        if (hasUnsavedData()) {
          pendingSection = target;
          showUnsavedModal();
          return;
        }
      }
      showSection(target);
    }

    function hasUnsavedData() {
      // التحقق من وجود بيانات في حقول النموذج الرئيسية
      return document.getElementById("breederName").value ||
             document.getElementById("breederPhone").value ||
             document.getElementById("breederLocation").value ||
             document.getElementById("vaccinationDate").value ||
             document.getElementById("optionalNextAppointment").value;
    }

    function showUnsavedModal() {
      document.getElementById("unsavedModal").classList.remove("hidden");
    }

    function proceedToSection() {
      document.getElementById("unsavedModal").classList.add("hidden");
      clearMainForm();
      showSection(pendingSection);
      pendingSection = "";
    }

    function clearMainForm() {
      document.getElementById("breederName").value = "";
      document.getElementById("breederPhone").value = "";
      document.getElementById("breederLocation").value = "";
      document.getElementById("vaccinationDate").value = "";
      document.getElementById("optionalNextAppointment").value = "";
      document.getElementById("previousAppointmentsContainer").innerHTML = "";
    }

    function showSection(section) {
      const sections = ["login", "register", "main", "breeders", "resetPassword", "adminPanel", "breederDetail"];
      sections.forEach(s => {
        document.getElementById(s).classList.add("hidden");
      });
      if (section === "adminPanel" && localStorage.getItem("username")?.toLowerCase() !== "ownership") {
        alert("غير مصرح");
        return;
      }
      document.getElementById(section).classList.remove("hidden");
      document.getElementById("menu").classList.remove("show");
      if (section === "breeders") {
        showBreeders();
      }
      if (section === "adminPanel") {
        showAdminPanel();
      }
    }

    function updateWelcome() {
      let username = localStorage.getItem("username");
      document.getElementById("welcome").innerText = "أهلا بك يا " + username;
      if (username.toLowerCase() === "ownership") {
        document.getElementById("adminPanelBtn").classList.remove("hidden");
      } else {
        document.getElementById("adminPanelBtn").classList.add("hidden");
      }
    }

    function loginUser() {
      let username = document.getElementById("loginUsername").value;
      let password = document.getElementById("loginPassword").value;
      let accountData;
      if (username.toLowerCase() === "admin") {
        accountData = localStorage.getItem("account_admin");
      } else {
        accountData = localStorage.getItem("account_" + username);
      }
      if (accountData) {
        if (username.toLowerCase() === "ownership") {
          accountData = atob(accountData);
        }
        let account = JSON.parse(accountData);
        if (username === account.username && password === account.password) {
          if (account.banned) {
            alert("تم تبنديك بواسطة المالك السبب: " + account.banReason);
            return;
          }
          localStorage.setItem("username", username);
          breeders = JSON.parse(localStorage.getItem("breeders_" + username)) || [];
          updateWelcome();
          showSection("main");
        } else {
          alert("اسم المستخدم أو كلمة المرور غير صحيحة");
        }
      } else {
        alert("الحساب غير موجود. الرجاء إنشاء حساب.");
      }
    }

    function registerUser() {
      let username = document.getElementById("registerUsername").value;
      let email = document.getElementById("registerEmail").value;
      let password = document.getElementById("registerPassword").value;
      let confirmPassword = document.getElementById("registerConfirmPassword").value;
        
      if (username.toLowerCase() === "admin") {
        alert("اسم المستخدم admin محجوز");
        return;
      }
      if (!email) {
        alert("يرجى إدخال البريد الإلكتروني");
        return;
      }
      if (password !== confirmPassword) {
        alert("كلمة المرور وتأكيدها غير متطابقين");
        return;
      }
      if (username.toLowerCase() === "ownership") {
        let count = localStorage.getItem("ownershipCount") || 0;
        if (parseInt(count) >= 2) {
          alert("لا يمكنك إنشاء حساب بالاسم ownership لأكثر من شخصين");
          return;
        } else {
          localStorage.setItem("ownershipCount", parseInt(count) + 1);
        }
      }
      if (localStorage.getItem("account_" + username)) {
        alert("اسم المستخدم موجود بالفعل");
        return;
      }
      let account = {   
        username,   
        email,   
        password,   
        createdAt: new Date().toISOString()
      };
      if (username.toLowerCase() === "ownership") {
        let encryptedAccount = btoa(JSON.stringify(account));
        localStorage.setItem("account_" + username, encryptedAccount);
      } else {
        localStorage.setItem("account_" + username, JSON.stringify(account));
      }
      localStorage.setItem("username", username);
      breeders = JSON.parse(localStorage.getItem("breeders_" + username)) || [];
      updateWelcome();
      showSection("main");
    }

    function resetPassword() {
      let username = document.getElementById("resetUsername").value;
      let email = document.getElementById("resetEmail").value;
      let newPassword = document.getElementById("resetNewPassword").value;
      let confirmPassword = document.getElementById("resetConfirmPassword").value;
        
      if (newPassword !== confirmPassword) {
        alert("كلمة المرور وتأكيدها غير متطابقين");
        return;
      }
      let accountData = localStorage.getItem("account_" + username);
      if (!accountData) {
        alert("الحساب غير موجود");
        return;
      }
      if (username.toLowerCase() === "ownership") {
        accountData = atob(accountData);
      }
      let account = JSON.parse(accountData);
      if (account.email !== email) {
        alert("الايميل او اسم المستخدم غير صالح");
        return;
      }
      account.password = newPassword;
      if (username.toLowerCase() === "ownership") {
        localStorage.setItem("account_" + username, btoa(JSON.stringify(account)));
      } else {
        localStorage.setItem("account_" + username, JSON.stringify(account));
      }
      alert("تم إعادة تعيين كلمة المرور بنجاح");
      showSection("login");
    }

    function handleNextAppointmentChange() {
      let select = document.getElementById("nextAppointment");
      let optionalDiv = document.getElementById("optionalDateDiv");
      if (select.value === "optional") {
        optionalDiv.classList.remove("hidden");
      } else {
        optionalDiv.classList.add("hidden");
      }
    }

    function addPreviousAppointmentField() {
      const container = document.getElementById("previousAppointmentsContainer");
      const div = document.createElement("div");
      div.className = "prev-app";
      div.style.marginBottom = "10px";
      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.placeholder = "اختر تاريخ الموعد";
      dateInput.onchange = function() {
        if (!this.nextElementSibling) {
          const vaccineSelect = document.createElement("select");
          vaccineSelect.innerHTML = `
            <option value="معوي">معوي</option>
            <option value="دموي">دموي</option>
            <option value="مزدوج">مزدوج</option>
            <option value="طاعون">طاعون</option>
            <option value="جدري">جدري</option>
            <option value="قلاعية">قلاعية</option>
          `;
          vaccineSelect.style.marginLeft = "10px";
          this.parentElement.appendChild(vaccineSelect);
        }
      };
      div.appendChild(dateInput);
      container.appendChild(div);
    }

    // دالة عرض الإشعارات مع أيقونة في أقصى اليمين
    function showNotification(msg, type = "success") {
      let notification = document.createElement("div");
      notification.className = "notification " + type;
      
      let textSpan = document.createElement("span");
      textSpan.innerText = msg;
      notification.appendChild(textSpan);
      
      let circle = document.createElement("div");
      circle.className = "circle";
      // استخدم رمز ✓ للنجاح ورمز ! للتنبيه أو الخطأ
      circle.innerText = type === "success" ? "✓" : "!";
      notification.appendChild(circle);
      
      let progress = document.createElement("div");
      progress.className = "progress";
      notification.appendChild(progress);
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = "fadeOut 2s forwards";
        setTimeout(() => {
          notification.remove();
        }, 2000);
      }, 3000);
    }

    // دالة لحساب الوقت المتبقي بالايام والساعات مع عرض القيمة بالسالب إذا انتهى الموعد
    function calculateRemainingTime(date) {
      let diff = new Date(date) - new Date();
      let days = Math.floor(diff / (1000 * 60 * 60 * 24));
      let hours = Math.floor((Math.abs(diff) % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      return `${days} أيام و ${hours} ساعة`;
    }

    // عند الضغط على زر الإرسال، يتم حفظ بيانات المربي
    function addBreeder() {
      let name = document.getElementById("breederName").value;
      let phone = document.getElementById("breederPhone").value;
      let location = document.getElementById("breederLocation").value;
      let vaccine = document.getElementById("vaccineType").value;
      let vaccinationDate = document.getElementById("vaccinationDate").value;
      let nextAppointmentSelect = document.getElementById("nextAppointment").value;
      let nextAppointment;
      
      if (!name || !phone || !vaccinationDate) {
        showNotification("يرجى تعبئة الحقول كاملة!", "error");
        return;
      }
      
      let vacDate = new Date(vaccinationDate);
      if (nextAppointmentSelect === "optional") {
        let optionalDate = document.getElementById("optionalNextAppointment").value;
        if (!optionalDate) {
          showNotification("يرجى تعبئة الحقول كاملة!", "error");
          return;
        }
        nextAppointment = new Date(optionalDate);
      } else {
        nextAppointment = new Date(vacDate.getTime() + parseInt(nextAppointmentSelect) * 24 * 60 * 60 * 1000);
      }
        
      let prevContainer = document.getElementById("previousAppointmentsContainer");
      let prevNodes = prevContainer.querySelectorAll(".prev-app");
      let prevApps = [];
      prevNodes.forEach(div => {
        let dateVal = div.querySelector("input[type='date']").value;
        let vaccineSelect = div.querySelector("select");
        let vaccineVal = vaccineSelect ? vaccineSelect.value : "";
        if (dateVal) {
          prevApps.push({ date: dateVal, vaccine: vaccineVal });
        }
      });
      // إذا انتهى موعد الجاي (أي في الماضي) تتم إضافته تلقائيًا كموعد سابق
      if(new Date(nextAppointment) < new Date()){
        prevApps.push({ date: nextAppointment.toISOString().split("T")[0], vaccine });
      }
      
      breeders.push({ name, phone, location, vaccine, vaccinationDate, nextAppointment, previousAppointments: prevApps });
      localStorage.setItem("breeders_" + localStorage.getItem("username"), JSON.stringify(breeders));

      showNotification("تم الإرسال بنجاح!", "success");
      clearMainForm();
      showBreeders();
    }

    function showBreeders() {
      let recordsList = document.getElementById("records-list");
      recordsList.innerHTML = "";
      breeders.forEach((breeder, index) => {
        let recordDiv = document.createElement("div");
        recordDiv.className = "record";
        // إضافة تأخير تدريجي لكل سجل
        recordDiv.style.animationDelay = (index * 0.2) + "s";
        recordDiv.innerHTML = `
          ${breeder.name} - الموعد الجاي: ${calculateRemainingTime(breeder.nextAppointment)}
          <button class="edit-btn" onclick="editBreeder(${index}); event.stopPropagation();">تعديل</button>
          <button class="delete-btn" onclick="deleteBreeder(${index}); event.stopPropagation();">حذف</button>
        `;
        recordDiv.onclick = function() {
          showBreederDetail(index);
        };
        recordsList.appendChild(recordDiv);
      });
    }

    function showBreederDetail(index) {
      let breeder = breeders[index];
      document.getElementById("detailName").innerText = "اسم المربي: " + breeder.name;
      document.getElementById("detailPhone").innerText = "رقم الجوال: " + breeder.phone;
      document.getElementById("detailLocation").innerText = "الموقع: " + (breeder.location || "غير محدد");
      document.getElementById("detailVaccine").innerText = "نوع التطعيم: " + breeder.vaccine;
      document.getElementById("detailNextAppointment").innerText = "الموعد الجاي: " + calculateRemainingTime(breeder.nextAppointment);
      let detailPrev = document.getElementById("detailPreviousAppointments");
      detailPrev.innerHTML = "";
      if (breeder.previousAppointments && breeder.previousAppointments.length > 0) {
        breeder.previousAppointments.forEach(app => {
          let div = document.createElement("div");
          div.style.position = "relative";
          div.style.padding = "5px 0";
          let p = document.createElement("p");
          p.innerText = app.date + " - " + app.vaccine;
          p.style.display = "inline-block";
          p.style.margin = "0";
          div.appendChild(p);
          // زر لتبديل حالة الموعد (يسار = افتراضي، يمين = مفعل)
          let toggleBtn = document.createElement("button");
          toggleBtn.className = "toggle-btn left";
          toggleBtn.innerText = "⇆";
          toggleBtn.onclick = function(e) {
            e.stopPropagation();
            if (toggleBtn.classList.contains("left")) {
              toggleBtn.classList.remove("left");
              toggleBtn.classList.add("right");
            } else {
              toggleBtn.classList.remove("right");
              toggleBtn.classList.add("left");
            }
          };
          div.appendChild(toggleBtn);
          detailPrev.appendChild(div);
        });
      } else {
        detailPrev.innerText = "لايوجد";
      }
      showSection("breederDetail");
    }

    function deleteBreeder(index) {
      if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
        breeders.splice(index, 1);
        localStorage.setItem("breeders_" + localStorage.getItem("username"), JSON.stringify(breeders));
        showBreeders();
      }
    }

    function editBreeder(index) {
      let breeder = breeders[index];
      document.getElementById("breederName").value = breeder.name;
      document.getElementById("breederPhone").value = breeder.phone;
      document.getElementById("breederLocation").value = breeder.location || "";
      document.getElementById("vaccineType").value = breeder.vaccine;
      document.getElementById("vaccinationDate").value = breeder.vaccinationDate;
      document.getElementById("nextAppointment").selectedIndex = 0;
      breeders.splice(index, 1);
      localStorage.setItem("breeders_" + localStorage.getItem("username"), JSON.stringify(breeders));
      showSection('main');
    }

    function searchBreeders() {
      let query = document.getElementById("search").value.toLowerCase();
      let recordsList = document.getElementById("records-list");
      recordsList.innerHTML = "";
      breeders.forEach((breeder, index) => {
        if (breeder.name.toLowerCase().includes(query) || breeder.vaccine.toLowerCase().includes(query)) {
          let recordDiv = document.createElement("div");
          recordDiv.className = "record";
          recordDiv.style.animationDelay = (index * 0.2) + "s";
          recordDiv.innerHTML = `
            ${breeder.name} - الموعد الجاي: ${calculateRemainingTime(breeder.nextAppointment)}
            <button class="edit-btn" onclick="editBreeder(${index}); event.stopPropagation();">تعديل</button>
            <button class="delete-btn" onclick="deleteBreeder(${index}); event.stopPropagation();">حذف</button>
          `;
          recordDiv.onclick = function() {
            showBreederDetail(index);
          };
          recordsList.appendChild(recordDiv);
        }
      });
    }

    function showAdminPanel() {
      let accountsList = document.getElementById("accounts-list");
      accountsList.innerHTML = "";
      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith("account_")) {
          let accountRaw = localStorage.getItem(key);
          let account;
          if (key === "account_ownership") {
            account = JSON.parse(atob(accountRaw));
          } else {
            account = JSON.parse(accountRaw);
          }
          if (account.banned) continue;
          let div = document.createElement("div");
          div.className = "record";
          let innerHTML = `
            ${account.username}
            <button class="details-btn" onclick="toggleAccountDetails('${key}', this.parentElement)">عرض التفاصيل</button>
          `;
          if (account.username.toLowerCase() !== "admin") {
            innerHTML += `<button class="delete-btn" onclick="banUser('${key}')">تبنيد المستخدم</button>`;
          }
          div.innerHTML = innerHTML;
          accountsList.appendChild(div);
        }
      }
    }

    function toggleAccountDetails(key, div) {
      let detailsDiv = document.getElementById(`account-details-${key}`);
      if (detailsDiv) {
        detailsDiv.remove();
      } else {
        let accountRaw = localStorage.getItem(key);
        let account;
        if (key === "account_ownership") {
            account = JSON.parse(atob(accountRaw));
        } else {
            account = JSON.parse(accountRaw);
        }
        let details = document.createElement("div");
        details.id = `account-details-${key}`;
        details.innerHTML = `
          <p>البريد الإلكتروني: ${account.email}</p>
          <p>كلمة المرور: ${account.password}</p>
          <p>موعد إنشاء الحساب: ${account.createdAt}</p>
          <button class="hide-btn" onclick="toggleAccountDetails('${key}', this.parentElement.parentElement)">إخفاء التفاصيل</button>
        `;
        div.appendChild(details);
      }
    }

    function banUser(key) {
      let accountRaw = localStorage.getItem(key);
      let account;
      if (key === "account_ownership") {
         account = JSON.parse(atob(accountRaw));
      } else {
         account = JSON.parse(accountRaw);
      }
      if (account.username.toLowerCase() === "admin") {
        alert("لا يمكن تبنيد حساب المسؤول");
        return;
      }
      let reason = prompt("أدخل سبب التبنيد:");
      if (reason) {
        account.banned = true;
        account.banReason = reason;
        if (account.username.toLowerCase() === "ownership") {
          localStorage.setItem(key, btoa(JSON.stringify(account)));
        } else {
          localStorage.setItem(key, JSON.stringify(account));
        }
        alert("تم تبنيد المستخدم " + account.username);
        showAdminPanel();
      }
    }

    function logout() {
      if (confirm("متاكد من تسجيل الخروج؟")) {
        localStorage.removeItem("username");
        showSection("login");
        alert("تم تسجيل الخروج");
      }
    }

    window.onload = function() {
      if (localStorage.getItem("username")) {
        updateWelcome();
        let username = localStorage.getItem("username");
        breeders = JSON.parse(localStorage.getItem("breeders_" + username)) || [];
        showSection("main");
      } else {
        showSection("login");
      }
      showBreeders();
    }
  </script>

  <p style="margin-top:30px; font-size:12px;">تم صنع الموقع بواسطة الدكتور علي بلال</p>
</body>
</html>